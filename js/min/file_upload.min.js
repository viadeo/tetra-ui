/*! Tetra UI v1.2.9 | (MIT Licence) (c) Viadeo/APVO Corp - inspired by Bootstrap (c) Twitter, Inc. (Apache 2 Licence) */

tetra.model.register("file_upload",{scope:"file_upload",req:{save:{url:"{0}",uriParams:["url"],method:"POST",processData:!1,contentType:!1}},attr:{data:""},methods:function(){return{validate:function(a,b){return b}}}}),tetra.controller.register("file_upload",{scope:"file_upload",use:["file_upload"],constr:function(a,b,c,d){"use strict";return{events:{model:{file_upload:{}},view:{perfomUpload:function(a){d("file_upload").create({data:a.data}).save({uriParams:{url:a.url}})},broadcastResponse:function(a){c.notify("file_upload: response",a)},broadcastSubmit:function(a){c.notify("file_upload: submitted",a)}}},methods:{init:function(){}}}}}),tetra.view.register("file_upload",{scope:"file_upload",use:["file_upload"],constr:function(a,b,c){"use strict";return{events:{user:{submit:{".form-async-upload":function(b,c){b.preventDefault(),a.methods.submitAsyncForm(c)}}},controller:{"file_upload: submit":function(b){a.methods.submitAsyncForm(c(b))}}},methods:{init:function(){},supportNativeUpload:function(){return!1},submitAsyncForm:function(d){var e=c(d);if(b.notify("broadcastSubmit",{id:e.attr("id")}),a.methods.supportNativeUpload()){var f=new FormData(e);e.find("input, textarea, select").each(function(a,b){var d=c(b);"file"===d.attr("type")?d[0].files.length>0&&f.append(d.attr("name"),d[0].files[0]):f.append(d.attr("name"),d.val())}),b.notify("perfomUpload",{data:f,url:e.attr("action")})}else{var g=document.createElement("iframe");c(g).attr("name",e.attr("id")+"_Frame").css("display","none"),e.attr("target",e.attr("id")+"_Frame").append(g).removeClass("form-async-upload").submit(),g.attachEvent?g.attachEvent("onload",function(){a.methods.handleIframeResponse(g,e)}):g.addEventListener("load",function(){a.methods.handleIframeResponse(g,e)},!0)}},handleIframeResponse:function(a,c){try{var d=JSON.parse(a.contentWindow.document.body.innerHTML);b.notify("broadcastResponse",{id:c.attr("id"),resp:d,json:!0})}catch(e){var d=a.contentWindow.document.body.innerHTML;b.notify("broadcastResponse",{id:c.attr("id"),resp:d,json:!1})}c.addClass("form-async-upload"),a.remove()}}}}});